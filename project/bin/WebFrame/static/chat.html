<!DOCTYPE html>
<html lang="en" xmlns:asp="http://www.w3.org/1999/html">

<head>
<meta charset="UTF-8">
<title>Direct Messaging</title>

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="http://176.215.133.52:9999/save/project/bin/WebFrame/static/css/reset.min.css">
<script src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/js/jQuery/jquery-3.4.1.js"></script>

<link rel="stylesheet" href="http://176.215.133.52:9999/save/project/bin/WebFrame/static/css/style.css">
<link rel="shortcut icon" href="http://176.215.133.52:9999/save/project/bin/WebFrame/static/img/favicon.ico"
          type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="http://176.215.133.52:9999/save/project/bin/WebFrame/static/css/wEmoji.css">

</head>

<body onload="hiddens();emoji_click();">

  <div class="wrapper_chat">
    <div class="container">
        <div class="left">
            <div class="top">
                <input type="text" placeholder="Search" />
                <a href="javascript:;" class="search"></a>
            </div>
            <ul class="people">
                <!--<li class="person" data-chat="person1">-->
                    <!--<img src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/images/dog.png" alt="" />-->
                    <!--<span class="name">Thomas Bangalter</span>-->
                    <!--<span class="time">2:09 PM</span>-->
                    <!--<span class="preview">I was wondering...</span>-->
                <!--</li>-->
<!--                <li class="person" data-chat="person2">-->
<!--                    <img src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/images/dog.png" alt="" />-->
<!--                    <span class="name">Dog Woofson</span>-->
<!--                    <span class="time">1:44 PM</span>-->
<!--                    <span class="preview">I've forgotten how it felt before</span>-->
<!--                </li>-->
                <!--<li class="person" data-chat="person3">-->
                    <!--<img src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/images/dog.png" alt="" />-->
                    <!--<span class="name">Louis CK</span>-->
                    <!--<span class="time">2:09 PM</span>-->
                    <!--<span class="preview">But we’re probably gonna need a new carpet.</span>-->
                <!--</li>-->
                <!--<li class="person" data-chat="person4">-->
                    <!--<img src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/images/dog.png" alt="" />-->
                    <!--<span class="name">Bo Jackson</span>-->
                    <!--<span class="time">2:09 PM</span>-->
                    <!--<span class="preview">It’s not that bad...</span>-->
                <!--</li>-->
                <!--<li class="person" data-chat="person5">-->
                    <!--<img src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/images/dog.png" alt="" />-->
                    <!--<span class="name">Michael Jordan</span>-->
                    <!--<span class="time">2:09 PM</span>-->
                    <!--<span class="preview">Wasup for the third time like is -->
<!--you blind bitch</span>-->
                <!--</li>-->
                <!--<li class="person" data-chat="person6">-->
                    <!--<img src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/images/dog.png" alt="" />-->
                    <!--<span class="name">Drake</span>-->
                    <!--<span class="time">2:09 PM</span>-->
                    <!--<span class="preview">howdoyoudoaspace</span>-->
                <!--</li>-->
            </ul>
        </div>
        <div class="right">
            <div class="top"><span>To: <span class="name"></span></span></div>
<!--            <div class="chat" data-chat="person1">-->
<!--                <div class="conversation-start">-->
<!--                    <span>Today, 6:48 AM</span>-->
<!--                </div>-->
<!--                <div class="bubble you">-->
<!--                    Hello,-->
<!--                </div>-->
<!--                <div class="bubble you">-->
<!--                    it's me.-->
<!--                </div>-->
<!--                <div class="bubble you">-->
<!--                    I was wondering...-->
<!--                </div>-->
<!--            </div>-->
<!--            <div class="chat" data-chat="person2">-->
<!--                <div class="conversation-start">-->
<!--                    <span>Today, 5:38 PM</span>-->
<!--                </div>-->
<!--                <div class="bubble you">-->
<!--                    Hello, can you hear me?-->
<!--                </div>-->
<!--                <div class="bubble you">-->
<!--                    I'm in California dreaming-->
<!--                </div>-->
<!--                <div class="bubble me">-->
<!--                    ... about who we used to be.-->
<!--                </div>-->
<!--                <div class="bubble me">-->
<!--                    Are you serious?-->
<!--                </div>-->
<!--                <div class="bubble you">-->
<!--                    When we were younger and free...-->
<!--                </div>-->
<!--                <div class="bubble you">-->
<!--                    I've forgotten how it felt before-->
<!--                </div>-->
<!--            </div>-->
            <!--<div class="chat" data-chat="person3">-->
                <!--<div class="conversation-start">-->
                    <!--<span>Today, 3:38 AM</span>-->
                <!--</div>-->
                <!--<div class="bubble you">-->
                    <!--Hey human!-->
                <!--</div>-->
                <!--<div class="bubble you">-->
                    <!--Umm... Someone took a shit in the hallway.-->
                <!--</div>-->
                <!--<div class="bubble me">-->
                    <!--... what.-->
                <!--</div>-->
                <!--<div class="bubble me">-->
                    <!--Are you serious?-->
                <!--</div>-->
                <!--<div class="bubble you">-->
                    <!--I mean...-->
                <!--</div>-->
                <!--<div class="bubble you">-->
                    <!--It’s not that bad...-->
                <!--</div>-->
                <!--<div class="bubble you">-->
                    <!--But we’re probably gonna need a new carpet.-->
                <!--</div>-->
            <!--</div>-->
            <div class="write">
                <a href="#" class="write-link attach"></a>
                <div style="width: 347px;height: 40px;float: left;">
                    <textarea  id="chat_text"style="width: 347px;height: 40px;"></textarea>
                </div>
                <a  class="write-link smiley" id="show_emoji" onclick="hiddens()"></a>
                <form>
                    <button class="write-link send" type="submit"></button>
                </form>
            </div>

        </div>
    </div>

    <div class="wrapper" id="emoji" style="float:left;top:62%;background-color:white;"></div>
      <script>
      function hidden(status){
          var emoji=document.getElementById("emoji");
          <!--console.log(emoji.children["0"]);-->
          var a=emoji.children["0"];
          var b=emoji.children["1"];
          if (status==true){
            status="display:block"
          }else{
            status="display:none"
          }
          a.setAttribute("style",status);
          b.setAttribute("style",status);
       }
       function hiddens(){
          <!--em=$("div[class=write]")-->
          var em=$("#show_emoji");
          var em_class=em.attr("class");
          if(em_class=="write-link smiley hidden"){
              em.attr("class","write-link smiley");
              hidden(true)
          }else{
              em.attr("class","write-link smiley hidden");
              hidden(false)
          }
      }
      </script>

    <!--<button type="button" onclick='hiddens()'>隐藏</button>-->
</div>

  

<!--<script  src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/js/index.js"></script>-->



<script type="text/javascript" src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/js/wEmoji.config.js"></script>
<script type="text/javascript" src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/js/wEmoji.js"></script>
<!--<script type="text/javascript" src="http://176.215.133.52:9999/save/project/bin/WebFrame/static/js/getEmoji.js"></script>-->
<script>
var we = new wantEmoji({
	wrapper : ".wrapper",
	callback : function(emojiCode){
	    var img_src=this.explain(emojiCode);
	    return img_src
	},
	autoInit : true
});
    var emojis=$("div[class=wEmoji-item]");
    // var emjCode=$("div[class=wEmoji-item]").attr("data-emj")
    // var img_src=we.callback(emjCode)
    function emoji_click(){
// =================emoji_click==================
//判断selector类型
var getSelectorType = (function(){
	var checkIdName = function(selector){
		var idReg = new RegExp("#");
		return (idReg.test(selector) ? "id" : checkClassName(selector));
	};
	var checkClassName = function(selector){
		var classReg = new RegExp(".");
		return (classReg.test(selector) ? "className" : "tagName");
	};
	return function(selector){
		return checkIdName(selector);
	};
});

        //获取目标元素
var getTargetNode = function(ele,selector){
	var type = getSelectorType(selector),
		nSec = selector.replace(/.|#/,"");
	if(ele === document){
		return null;
	}

	if( new RegExp(nSec).test(ele[type]) ){
		return ele;
	} else {
		return getTargetNode(ele.parentNode,selector);
	}
};
var down = "ontouchstart" in document ? "touchstart" : "mousedown";
var up = "ontouchend" in document ? "touchend" : "mouseup";
var move = "ontouchmove" in document ? "touchmove" : "mousemove";
            var chat_text=document.getElementById("chat_text");
            var parent_div=$(chat_text)[0].parentElement;
            // $(parent_div).append('<img src="emojiSources/paopao/18.png" style="width:20px;height:20px;position: relative;bottom:40px">')
            var content=document.querySelectorAll("div.wEmoji-content")[0];
            content.onclick = function(e){
                e = e || event;
                var emjCode=e.path[1].getAttribute("data-emj");
                var img_src=e.path[0].getAttribute("src");
                var old_text=$(chat_text).val();
                $(chat_text).val(old_text+emjCode);
                $(parent_div).append('<img src="'+img_src+'" style="width:20px;height:20px;position: relative;bottom:40px">')
                // console.log(emjCode)
                // console.log(img_src)
            };
            content["on"+down] = function(e){
			e = e || event;
			drag = true;
			x = e.pageX || e.touches[0].pageX;
		};

		content["on"+move] = function(e){
			e = e || event;
			e.stopPropagation();
			e.preventDefault();
		};

		content["on"+up] = function(e){
			e = e || event;
			if(drag){
				drag = false;
				var endX = e.pageX || e.changedTouches[0].pageX,
					dis = endX - x,
					idx;

				if(dis > 50){
					idx = Math.max(_self.activePage - 1,0);
					_self.showPage(idx);
				} else if (dis < -50){
					idx = Math.min(_self.activePage + 1,_self.totalPage - 1);
					_self.showPage(idx);
				}
				x = 0;
			}
		};
		$(chat_text).keydown(function(){
            $(parent_div).children("img").remove()
		})
// ===============emoji_click====================
    }
      // function emoji_addclick(){
      //
      //   for(var i=0;i<emojis.length;i++){
      //       // $(emojis[i]).attr("onclick","emoji_click();")
      //       $(emojis[i]).on("click",function(data){
      //           var emjCode=$(data["currentTarget"]).attr("data-emj");
      //           var img_obj=we.callback(emjCode);
      //           // console.log(emjCode);
      //           // console.log(img_obj);
      //           reg=/".+"/;
      //           $("#chat_text").html(chat_text_value+"<img style='width: 25px;height: 25px;' src="+img_src+">")
      //       })
      //   }
      // }   var img_src=img_obj.match(reg)[0].replace("\"","").replace("\"","")
      //           console.log(img_src);
      //           var chat_text_value=$("#chat_text").html();
      //           $("#chat_text").html(chat_text_value+"<img style='width: 25px;height: 25px;' src="+img_src+">")
      //       })
      //   }
      // }
</script>
</body>

</html>
<script>
     $.ajax({
             type:'GET',
             dataType:'jsonp',
             jsonp:'callback',
             jsonpCallback:"userHandler",
             url: "http://176.215.133.52:8080",
             success: function(data) {
                 // ##########success#########
                 //                 获取ajax请求返回的数据
                 var all_messages=[];
                 var users_id=[];
                 var users=[];
                 var all_msg=[];
                 var fi_msg=[];
                 console.log(data);
                 for(var i=0;i<data.length;i++){
                     if(users_id.includes(data[i].id)){
                         continue;
                     }else{
                         users_id.push(data[i].myid);
                         users.push({
                             "id":data[i].myid,
                             "username":data[i].username,
                             "img":data[i].img,
                             "other_id":data[i].othersid,
                             // "other_name":data[i].other_name
                             "other_name":[]
                         });
                     }
                 }
                 //添加对方姓名---------
                 for(var i in users){
                     for(var c in data){
                         if(data[c].id==users[i]["id"]){
                             users[i]["other_name"].push(data[c].other_name)
                         }
                     }
                 }
                 //--------------------
                 for(var r in users){
                     for(var c in data){
                         if(data[c].id==users[r]["id"]){
                             all_messages.push({"self":users[r]["id"],"other":data[c].othersid,"message":data[c].message});
                         }
                     }
                 }
                 for (var r in users) {
                     for(var c in all_messages){
                         if(all_messages[c]["self"]==users[r]["id"] || all_messages[c]["other"]==users[r]["id"]){
                             if(all_messages[c]["self"]==users[r]["id"]){
                                 all_msg.push([users[r]["id"],"self",all_messages[c]["message"]])
                             }
                             if(all_messages[c]["other"]==users[r]["id"]){
                                 all_msg.push([users[r]["id"],"other",all_messages[c]["message"]])
                             }
                         }
                     }
                 }
                 for (var r in users) {
                     fi_msg.push({
                         "users":{
                             "id":users[r]["id"],
                             "username":users[r]["username"],
                             "img":users[r]["img"],
                             "other_id":users[r]["other_id"],
                             "other_name":users[r]["other_name"]
                         },
                         "message":[]
                     })
                 }
                 for (var r in users) {
                     for (var i in all_msg) {
                         if(all_msg[i][0]==users[r]["id"]) {
                             // console.log(all_msg[i])
                             fi_msg[r]["message"].push([all_msg[i][1], all_msg[i][2]])
                         }
                     }
                 }
                 // console.log(fi_msg);
                 for(var i in fi_msg){
                     //动态添加元素=================================
                     console.log(fi_msg[i]);
                     var persons=$("ul[class=people]");//左边
                     var right_top=$("div[class=right]>div[class=top]"); //右边
                     var data_chat="person"+fi_msg[i]["users"]["id"];
                     var img_src=fi_msg[i]["users"]["img"];
                     var show_name=fi_msg[i]["users"]["username"];
                     var other_name=fi_msg[i]["users"]["other_name"];
                     var messages=fi_msg[i]["message"];
                     for(var i in messages){
                         if(messages[i][0]=="self"){
                             var show_messages=messages[i][1]
                         }
                     }
                     var li01='<li class="person" data-chat='+data_chat+'>' +
                     '<img src='+img_src+' alt="">' +
                     '<span class="name">'+show_name+'</span><br>' +
                     '<span class="preview">'+show_messages+'</span>' +
                     '</li>';
                     persons.append(li01);
                     var right_div='<div class="chat" data-chat='+data_chat+'>\n' +
                     '            </div>';
                     var other_name_div="<div class='chat' style='height: 15px'>"+other_name+"</div>";
                     right_top.after(right_div);
                     var active_div=$("div[class=right]>div[data-chat="+data_chat+"]");
                     for(var i in messages){
                         if(messages[i][0]=="self"){
                             active_div.append("<div class='bubble me'>"+messages[i][1]+"</div>");
                         }else if(messages[i][0]=="other"){
                             active_div.append("<div class='bubble you'>"+messages[i][1]+"</div>");
                         }
                     }
                     //添加对方姓名div--------
                     for(var c in fi_msg[i]["users"]["other_name"]){
                         // fi_msg[i]["users"]["other_name"][c];
                         active_div.append(
                             "<div class='bubble me'>" +
                             ""+fi_msg[i]["users"]["other_name"][c]+"" +
                             "</div>"
                         )
                     }
                     //---------------------
                 //=====================================
                 }
                 var name1=data[0];
 //重新执行index.js中的代码
 document.querySelector('.chat[data-chat=person1]').classList.add('active-chat');
 document.querySelector('.person[data-chat=person1]').classList.add('active');

 var friends = {
   list: document.querySelector('ul.people'),
   all: document.querySelectorAll('.left .person'),
   name: '' };
 chat = {
   container: document.querySelector('.container .right'),
   current: null,
   person: null,
   name: document.querySelector('.container .right .top .name') };

 friends.all.forEach(function (f) {
   f.addEventListener('mousedown', function () {
     f.classList.contains('active') || setAciveChat(f);
   });
 });

 function setAciveChat(f) {
   friends.list.querySelector('.active').classList.remove('active');
   f.classList.add('active');
   chat.current = chat.container.querySelector('.active-chat');
   chat.person = f.getAttribute('data-chat');
   chat.current.classList.remove('active-chat');
   // var right_top=$("div[class=right]>div[class=top]")
   // var div_chat='<div class="chat" data-chat="person1"><div class="conversation-start"><span>Today, 6:28 AM</span></div><div class="bubble you">Wasup</div><div class="bubble you">Wasup</div><div class="bubble you">Wasup for the third time like is <br>you blind bitch</div></div>'
   // var div_emoji='<div class="wrapper" style="float:left"></div>'
   // right_top.after(div_chat)
   // var wrapper_chat=$("div[class=wrapper_chat]")
   // wrapper_chat.append(div_emoji)
   chat.container.querySelector('[data-chat="' + chat.person + '"]').classList.add('active-chat');
   friends.name = f.querySelector('.name').innerText;
   chat.name.innerHTML = friends.name;
 }

 // ##########success#########
             }
     })
</script>